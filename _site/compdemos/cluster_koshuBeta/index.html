<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Instructions for Using Koshu (beta) - Fred Hutch Biomedical Data Science Wiki</title>
<meta name="description" content="About Koshu">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Fred Hutch Biomedical Data Science Wiki">
<meta property="og:title" content="Instructions for Using Koshu (beta)">
<meta property="og:url" content="http://localhost:4000/compdemos/cluster_koshuBeta/">


  <meta property="og:description" content="About Koshu">







  <meta property="article:published_time" content="2019-04-02T18:09:25-07:00">



  <meta property="article:modified_time" content="2018-11-07T00:00:00-08:00">



  

  


<link rel="canonical" href="http://localhost:4000/compdemos/cluster_koshuBeta/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="index.html" type="application/atom+xml" rel="alternate" title="Fred Hutch Biomedical Data Science Wiki Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
              <a href="http://localhost:4000"><img src="/images/Biomedical-Data-Science-Wiki-logo.png" alt="FH biomedical data science wiki icon" width="600" align="left|middle" hspace="0"></a>
        <!--<a class="site-title" href="/">Fred Hutch Biomedical Data Science Wiki</a>-->

        <ul class="visible-links">
          
          
          <li class="masthead__menu-item">
            <a href="/generation/gen_index/" >Data Generation</a>
          </li>
          
          
          <li class="masthead__menu-item">
            <a href="/bioinformatics/inf_index/" >Bioinformatics</a>
          </li>
          
          
          <li class="masthead__menu-item">
            <a href="/computing/comp_index/" >Computing</a>
          </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z"
              transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Computing</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/comp_index/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/compdemos/" class="">Resource Library/HOWTOs</a></li>
          
            
            

            
            

            <li><a href="/scicompannounce/" class="">Announcements</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Access and Credentials</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/access_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/access_credentials/" class="">Credentials</a></li>
          
            
            

            
            

            <li><a href="/computing/access_methods/" class="">Methods</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Data Storage</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/store_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/store_databases/" class="">Database Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_posix/" class="">File Storage Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_objectstore/" class="">Object Storage Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_scratch/" class="">Temporary (Scratch) Storage</a></li>
          
            
            

            
            

            <li><a href="/computing/store_collaboration/" class="">Collaborative Storage Systems</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Large Scale Compute</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/cluster_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/linux_linux101/" class="">Linux Operating System</a></li>
          
            
            

            
            

            <li><a href="/computing/resource_overview/" class="">Technologies</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_software/" class="">Scientific Software</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_usingSlurm/" class="">Job Management</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_cloudCompute/" class="">Cloud Computing</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Instructions for Using Koshu (beta)">
    <meta itemprop="description" content="About Koshu">
    <meta itemprop="datePublished" content="April 02, 2019">
    <meta itemprop="dateModified" content="November 07, 2018">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Instructions for Using Koshu (beta)
</h1>
          
          <!-- <section class="page__share"> -->
<font size="2">
  <a href="http://github.com/FredHutch/wiki/blob/master/_compdemos/cluster_koshuBeta.md"><i class="fas fa-pen-square"></i>
  <span> Edit this Page via GitHub</span></a> &nbsp; &nbsp; &nbsp;
  <a href="http://github.com/FredHutch/wiki/issues"><i class="far fa-comment-dots"></i><span> Comment by Filing an Issue</span></a>&nbsp; &nbsp; &nbsp;
  <a href="https://fhbig.slack.com/#question-and-answer"><i class="fas fa-question-circle"></i>
  <span> Have Questions? Ask them here.</span></a>
</font>
<hr>

<!--  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fcompdemos%2Fcluster_koshuBeta%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> -->
<!-- </section> -->

        </header>
      


      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#about-koshu">About Koshu</a></li>
  <li><a href="#using-koshu">Using Koshu</a></li>
  <li><a href="#managing-cpus">Managing CPUS</a></li>
  <li><a href="#managing-gpus">Managing GPUs</a></li>
</ul>
            </nav>
          </aside>
        
        <h2 id="about-koshu">About Koshu</h2>

<p>The cluster <em>Koshu</em> is a cloud-based Slurm cluster based in Google’s Cloud Platform.</p>

<blockquote>
  <p><em>Koshu</em> is currently under beta as it is currently not sized for large-scale work and may experience more maintenance time than other clusters or be missing some functionalities.  We’re using this to “kick the tires,” make sure everything functions before bringing it into production.  Check back frequently for updates or, as always, contact <code class="highlighter-rouge">SciComp</code> with any questions or to note any problems you experience when using <em>Koshu</em>.</p>
</blockquote>

<p>At this time there are three partitions: the “campus” partition with smaller nodes, a “largenode” partition with nodes that have greater capacities (processors and memory), and a partition named “gpu” that has GPU capabilities.</p>

<table>
  <thead>
    <tr>
      <th>Partition</th>
      <th>Node Class</th>
      <th>Count</th>
      <th>Processors</th>
      <th>Memory</th>
      <th>GPU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>campus</td>
      <td>koshuf</td>
      <td>70</td>
      <td>4</td>
      <td>32,768 MB</td>
      <td>none</td>
    </tr>
    <tr>
      <td>largenode</td>
      <td>koshug</td>
      <td>10</td>
      <td>8</td>
      <td>262,144 MB</td>
      <td>none</td>
    </tr>
    <tr>
      <td>gpu</td>
      <td>koshuk</td>
      <td>10</td>
      <td>4</td>
      <td>131,072 MB</td>
      <td>1 NVIDIA Tesla v100</td>
    </tr>
  </tbody>
</table>

<p>Note that the processors are hyperthreaded, which means that each physical CPU could be assigned two threads.  Whether this is an improvement for your tools will affect how you run them.</p>

<p><em>Koshu</em> has access to most Hutch storage systems in the same paths as on <code class="highlighter-rouge">gizmo</code>.  The exception to this is the scratch directories: <code class="highlighter-rouge">/fh/scratch/delete10</code> and <code class="highlighter-rouge">/fh/scratch/delete30</code>.  These directories are on different file systems and are not available outside the <em>koshu</em> environment.</p>

<h2 id="using-koshu">Using <em>Koshu</em></h2>

<p>Much like <em>Beagle</em>, jobs are routed to Koshu by use of the <code class="highlighter-rouge">-M</code> option when running Slurm commands on campus resources (e.g. <code class="highlighter-rouge">rhinos</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch -M koshu ...
</code></pre></div></div>

<p>Note that <code class="highlighter-rouge">salloc</code> and <code class="highlighter-rouge">srun</code> do not support this.  To run interactive sessions you need to log into the host <em>koshu-login</em>.</p>

<h2 id="managing-cpus">Managing CPUS</h2>

<p>As indicated, there are 4 CPUs indicated in Slurm while the host has 8 available CPUs.  If your workload benefits or at least does not suffer from hyperthreading, then you can use all 8 of the processors.  However, if your workload won’t benefit from this, you need to adjust the way you launch your tools as many will default to using all configured processors on the node.</p>

<p>For example, <em>bowtie2</em> has the option <code class="highlighter-rouge">-p</code> to control the number of threads it will use:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bowtie2 -p 4 ...
</code></pre></div></div>

<p>would use four threads.  The best-practice for this would be to use the Slurm environment variable <code class="highlighter-rouge">SLURM_CPUS_ON_NODE</code> which will always contain the number of processors you have been assigned on the node:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bowtie2 -p ${SLURM_CPUS_ON_NODE} ...
</code></pre></div></div>

<h2 id="managing-gpus">Managing GPUs</h2>

<p>Two options are required for using the GPUs in this cluster.  First you must select the <em>gpu</em> partition and then you must select the number and type of GPU using Slurm’s <em>gres</em> options:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sbatch -M koshu -p gpu --gres=gpu:V100-SXM2-16GB:1 ...
</code></pre></div></div>

<p>It is a bit cumbersome, but this will (as the cluster gains capabilities) allow greater flexibilty in selecting resources for your job as well as ensuring that GPU tools run correctly.</p>

<p>Technically, omitting the <em>gres</em> option won’t prevent the job from running.  However, the job won’t have some necessary environment variables set and it would be possible that a node’s GPU would get oversubscribed or that other failures will occur.</p>

<p>There are several environment variables set in a job:</p>

<table>
  <thead>
    <tr>
      <th>Variable</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>CUDA_VISIBLE_DEVICES</td>
      <td>Tell CUDA capable tools which GPUs to use</td>
    </tr>
    <tr>
      <td>GPU_DEVICE_ORDINAL</td>
      <td>Tell OpenLC capable tools which GPUs to use</td>
    </tr>
    <tr>
      <td>SLURM_JOB_GPUS</td>
      <td>Environment variable set by Slurm with allocated GPUs</td>
    </tr>
  </tbody>
</table>

<p>These should automatically constrain most tools to the appropriate GPUS.  At this time, there’s only a single GPU per host, but we will likely adjust that depending on needs and input from the community, so ensuring that scripts and tools use these variables to control which GPUs are used is important.</p>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-11-07">November 07, 2018</time></p>
        
      </footer>

      <!-- <section class="page__share"> -->
<font size="2">
  <a href="http://github.com/FredHutch/wiki/blob/master/_compdemos/cluster_koshuBeta.md"><i class="fas fa-pen-square"></i>
  <span> Edit this Page via GitHub</span></a> &nbsp; &nbsp; &nbsp;
  <a href="http://github.com/FredHutch/wiki/issues"><i class="far fa-comment-dots"></i><span> Comment by Filing an Issue</span></a>&nbsp; &nbsp; &nbsp;
  <a href="https://fhbig.slack.com/#question-and-answer"><i class="fas fa-question-circle"></i>
  <span> Have Questions? Ask them here.</span></a>
</font>
<hr>

<!--  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fcompdemos%2Fcluster_koshuBeta%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> -->
<!-- </section> -->


      
  <nav class="pagination">
    
      <a href="/compdemos/aws-python/" class="pagination--pager" title="Using Python to Access AWS S3
">Previous</a>
    
    
      <a href="/compdemos/cluster_parallel/" class="pagination--pager" title="Parallel Computing on Slurm Clusters
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <input type="text" id="cse-search-input-box-id" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    </form>
    <div id="results" class="results">
        <gcse:searchresults-only></gcse:searchresults-only>    
    </div></div>

      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
          <li><a href="/contributors/"><i class="fas fa-user-edit"></i> See our Contributors</a></li>

          <li><a href="https://github.com/FredHutch/wiki"><i class="fab fa-fw fa-github"></i> See our GitHub Repo</a></li>

          <li><a href="https://fhbig.slack.com/"><i class="fab fa-fw fa-slack"> </i> Join the Conversation on Slack</a></li>

          <li><a href="https://fredhutch.github.io/FHBig/"><img src="/images/FHBig.png" alt="fhbig" width="40" align="left|middle" hspace="0"> Find Upcoming Events</a></li>

          <li><a href="https://www.fredhutch.io/"><img src="/images/fhio.png" alt="fredhutchio" width="20" align="left|middle" hspace="0"> Find Training</a></li>


  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Fred Hutch Biomedical Data Science Wiki. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>


<script>
  (function () {
    var cx = '018020560330782233421:waz3ch9w_wg';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
</script>





  </body>
</html>
