<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.15.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Running Tensorflow (and Keras) on GPUs - Fred Hutch Biomedical Data Science Wiki</title>
<meta name="description" content="In order to run tensorflow on GPUs you need to use a special version of Tensorflow. GPUs are currently installed on the Koshu cluster (Google cloud). In early 2019 GPUs will also be available on the new GizmoJ class nodes. For now please follow the instructions for getting a GPU based machines on Koshu:">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Fred Hutch Biomedical Data Science Wiki">
<meta property="og:title" content="Running Tensorflow (and Keras) on GPUs">
<meta property="og:url" content="http://localhost:4000/compdemos/tensorflow-gpu/">


  <meta property="og:description" content="In order to run tensorflow on GPUs you need to use a special version of Tensorflow. GPUs are currently installed on the Koshu cluster (Google cloud). In early 2019 GPUs will also be available on the new GizmoJ class nodes. For now please follow the instructions for getting a GPU based machines on Koshu:">







  <meta property="article:published_time" content="2019-04-02T18:09:25-07:00">



  <meta property="article:modified_time" content="2018-12-28T00:00:00-08:00">



  

  


<link rel="canonical" href="http://localhost:4000/compdemos/tensorflow-gpu/">







  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Person",
      "name": null,
      "url": "http://localhost:4000",
      "sameAs": null
    }
  </script>







<!-- end _includes/seo.html -->


<link href="index.html" type="application/atom+xml" rel="alternate" title="Fred Hutch Biomedical Data Science Wiki Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE ]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
              <a href="http://localhost:4000"><img src="/images/Biomedical-Data-Science-Wiki-logo.png" alt="FH biomedical data science wiki icon" width="600" align="left|middle" hspace="0"></a>
        <!--<a class="site-title" href="/">Fred Hutch Biomedical Data Science Wiki</a>-->

        <ul class="visible-links">
          
          
          <li class="masthead__menu-item">
            <a href="/generation/gen_index/" >Data Generation</a>
          </li>
          
          
          <li class="masthead__menu-item">
            <a href="/bioinformatics/inf_index/" >Bioinformatics</a>
          </li>
          
          
          <li class="masthead__menu-item">
            <a href="/computing/comp_index/" >Computing</a>
          </li>
          
        </ul>
        
        <button class="search__toggle" type="button">
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z"
              transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  
  
    
      
      
      
      
    
    
      

<nav class="nav__list">
  
  <input id="ac-toc" name="accordion-toc" type="checkbox" />
  <label for="ac-toc">Toggle Menu</label>
  <ul class="nav__items">
    
      <li>
        
          <span class="nav__sub-title">Computing</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/comp_index/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/compdemos/" class="">Resource Library/HOWTOs</a></li>
          
            
            

            
            

            <li><a href="/scicompannounce/" class="">Announcements</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Access and Credentials</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/access_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/access_credentials/" class="">Credentials</a></li>
          
            
            

            
            

            <li><a href="/computing/access_methods/" class="">Methods</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Data Storage</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/store_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/store_databases/" class="">Database Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_posix/" class="">File Storage Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_objectstore/" class="">Object Storage Systems</a></li>
          
            
            

            
            

            <li><a href="/computing/store_scratch/" class="">Temporary (Scratch) Storage</a></li>
          
            
            

            
            

            <li><a href="/computing/store_collaboration/" class="">Collaborative Storage Systems</a></li>
          
        </ul>
        
      </li>
    
      <li>
        
          <span class="nav__sub-title">Large Scale Compute</span>
        

        
        <ul>
          
            
            

            
            

            <li><a href="/computing/cluster_overview/" class="">Overview</a></li>
          
            
            

            
            

            <li><a href="/computing/linux_linux101/" class="">Linux Operating System</a></li>
          
            
            

            
            

            <li><a href="/computing/resource_overview/" class="">Technologies</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_software/" class="">Scientific Software</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_usingSlurm/" class="">Job Management</a></li>
          
            
            

            
            

            <li><a href="/computing/cluster_cloudCompute/" class="">Cloud Computing</a></li>
          
        </ul>
        
      </li>
    
  </ul>
</nav>
    
  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Running Tensorflow (and Keras) on GPUs">
    <meta itemprop="description" content="In order to run tensorflow on GPUs you need to use a special version of Tensorflow. GPUs are currently installed on the Koshu cluster (Google cloud). In early 2019 GPUs will also be available on the new GizmoJ class nodes. For now please follow the instructions for getting a GPU based machines on Koshu:">
    <meta itemprop="datePublished" content="April 02, 2019">
    <meta itemprop="dateModified" content="December 28, 2018">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Running Tensorflow (and Keras) on GPUs
</h1>
          
          <!-- <section class="page__share"> -->
<font size="2">
  <a href="http://github.com/FredHutch/wiki/blob/master/_compdemos/tensorflow-gpu.md"><i class="fas fa-pen-square"></i>
  <span> Edit this Page via GitHub</span></a> &nbsp; &nbsp; &nbsp;
  <a href="http://github.com/FredHutch/wiki/issues"><i class="far fa-comment-dots"></i><span> Comment by Filing an Issue</span></a>&nbsp; &nbsp; &nbsp;
  <a href="https://fhbig.slack.com/#question-and-answer"><i class="fas fa-question-circle"></i>
  <span> Have Questions? Ask them here.</span></a>
</font>
<hr>

<!--  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fcompdemos%2Ftensorflow-gpu%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> -->
<!-- </section> -->

        </header>
      


      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-file-alt"></i> On This Page</h4></header>
              <ul class="toc__menu">
  <li><a href="#gpu-tensorflow-in-a-python-environment">GPU Tensorflow in a Python Environment</a>
    <ul>
      <li><a href="#gpu-tensorflow-with-the-standard-python">GPU Tensorflow with the standard Python</a></li>
      <li><a href="#gpu-tensorflow-in-a-virtual-environment">GPU Tensorflow in a virtual environment</a></li>
      <li><a href="#gpu-tensorflow-from-a-singularity-container">GPU Tensorflow from a singularity container</a></li>
    </ul>
  </li>
  <li><a href="#tensorflow-from-r">Tensorflow from R</a></li>
  <li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
            </nav>
          </aside>
        
        <p>In order to run tensorflow on GPUs you need to use a special version of Tensorflow. GPUs are currently installed on the <a href="/compdemos/cluster_koshuBeta/">Koshu cluster</a> (Google cloud). In early 2019 GPUs will also be available on the new GizmoJ class nodes. For now please follow the instructions for getting a GPU based machines on Koshu:</p>

<h2 id="gpu-tensorflow-in-a-python-environment">GPU Tensorflow in a Python Environment</h2>

<h3 id="gpu-tensorflow-with-the-standard-python">GPU Tensorflow with the standard Python</h3>

<p>load a current version of Python 3.6 on Rhino using the ml shortcut for module load and then use pip3 to install the Tensorflow wheel made for Koshu and Gizmo</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ~$ ml Python/3.6.7-foss-2016b-fh2
    ~$ pip3 install --user --upgrade /app/src/tensorflow/14.04/python3.6/cuda10/tensorflow-1.12.0-cp36-cp36m-linux_x86_64.whl
</code></pre></div></div>

<p>then create a small python test script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    echo "#! /usr/bin/env python3" &gt; ~/tf-test.py
    echo "import tensorflow" &gt;&gt; ~/tf-test.py
    echo "from tensorflow.python.client import device_lib" &gt;&gt; ~/tf-test.py
    echo "print(tensorflow.__version__)" &gt;&gt; ~/tf-test.py
    echo "print(tensorflow.__path__)" &gt;&gt; ~/tf-test.py
    echo "print(device_lib.list_local_devices())" &gt;&gt; ~/tf-test.py
    chmod +x ~/tf-test.py
</code></pre></div></div>

<p>and run it on Koshu (for example)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ~$ sbatch -M koshu -p gpu --gres=gpu:V100-SXM2-16GB:1 -o out.txt ~/tf-test.py
    Submitted batch job 27074536 on cluster koshu
    ~$ tail -f out.txt
    1.12.0
    ['/home/petersen/.local/lib/python3.6/site-packages/tensorflow', '...']
    ...
    physical_device_desc: "device: 0, name: Tesla V100-SXM2-16GB, pci bus id: 0000:00:04.0, compute capability: 7.0"
</code></pre></div></div>

<p>if you want to switch back to the non-GPU version of Tensorflow just uninstall the GPU version you installed under .local</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ~$ pip3 uninstall tensorflow
    Uninstalling tensorflow-1.12.0:
    Would remove:
        /home/petersen/.local/bin/freeze_graph
        /home/petersen/.local/bin/saved_model_cli
        /home/petersen/.local/bin/tensorboard
        /home/petersen/.local/bin/tflite_convert
        /home/petersen/.local/bin/toco
        /home/petersen/.local/bin/toco_from_protos
        /home/petersen/.local/lib/python3.6/site-packages/tensorflow-1.12.0.dist-info/*
        /home/petersen/.local/lib/python3.6/site-packages/tensorflow/*
    Proceed (y/n)? y
        Successfully uninstalled tensorflow-1.12.0
</code></pre></div></div>

<h3 id="gpu-tensorflow-in-a-virtual-environment">GPU Tensorflow in a virtual environment</h3>

<p>Python virtual environments are useful for advanced users who would like to work with multiple versions of python packages. It is important to understand that the virtual env is tied to the Python environment you have previously loaded using the <code class="highlighter-rouge">ml</code> command. Let’s load a recent Python and create a virtual environment called <code class="highlighter-rouge">mypy</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ~$ ml Python/3.6.7-foss-2016b-fh2
    ~$ python3 -m venv mypy
    ~$ source ./mypy/bin/activate
    (mypy) petersen@rhino3:~$ which pip3
    /home/petersen/mypy/bin/pip3
</code></pre></div></div>

<p>Now that you have our own environment you can install packages with pip3. Leave out the –user option in this case because you want to install the package under the virtual environment and not under ~/.local</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    (mypy) petersen@rhino3:~$ pip3 install --upgrade /app/src/tensorflow/14.04/python3.6/cuda10/tensorflow-1.12.0-cp36-cp36m-linux_x86_64.whl
</code></pre></div></div>

<p>Now you can just continue with the example from <code class="highlighter-rouge">GPU Tensorflow with the standard Python</code>. After you are done with your virtual environment you can just run the <code class="highlighter-rouge">deactivate</code> script. No need to uninstall the tensorflow package:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    (mypy) petersen@rhino3:~$ deactivate 
    ~$ 
</code></pre></div></div>

<h3 id="gpu-tensorflow-from-a-singularity-container">GPU Tensorflow from a singularity container</h3>

<p>To run in a Singularity container, you need to start with a Docker image containing a modern Python and the <em>tensorflow-gpu</em> package installed.  The <a href="https://hub.docker.com/r/tensorflow/tensorflow/">Tensorflow Docker images</a> are all set up and ready.</p>

<p>After that load Singularity:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ml Singularity
</code></pre></div></div>

<blockquote>
  <p>Note that there is a <em>singularity</em> module (note the case) that is
out-of-date.  Loading <em>Singularity</em> (with caps) will give you the most modern
release which is typically what you want.</p>
</blockquote>

<p>After that, the only change is to enable NVIDIA support by adding the <code class="highlighter-rouge">--nv</code>
flag to <code class="highlighter-rouge">singularity exec</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>singularity exec -nv docker://tensorflow/tensorflow:latest-gpu python ...
</code></pre></div></div>

<p>Sample code is available in the <a href="https://github.com/FredHutch/slurm-examples/tree/master/tensorflow-gpu">slurm-examples repository</a>.</p>

<h2 id="tensorflow-from-r">Tensorflow from R</h2>

<p>Scientific Computing maintains custom builds of R and Python.
Python modules with fh suffixes have Tensorflow since version 3.6.1.
Only Python3 releases have the Tensorflow package. To use Tensorflow from
R, use the FredHutch Modules for R and Python.
Example Setup</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    ml R
    ml Python/3.6.7-foss-2016b-fh2

    # Start R
    R
    # R commands
    pyroot = Sys.getenv("EBROOTPYTHON")
    pypath &lt;- paste(pyroot, sep = "/", "bin/python")
    Sys.setenv(TENSORFLOW_PYTHON=pypath)
    library(tensorflow)
    tf_version()
    sess = tf$Session()
    hello &lt;- tf$constant('Hello, TensorFlow!')
    sess$run(hello)
    # Sample output: b'Hello, TensorFlow!'
</code></pre></div></div>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>First verify that you have a GPU (Tesla V100 or Geforce) active as well as CUDA V 10.0 or newer</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    petersen@koshuk0:~$ nvidia-smi 
    Thu Dec 27 14:44:19 2018       
    +-----------------------------------------------------------------------------+
    | NVIDIA-SMI 410.79       Driver Version: 410.79       CUDA Version: 10.0     |
    |-------------------------------+----------------------+----------------------+
    | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
    | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
    |===============================+======================+======================|
    |   0  Tesla V100-SXM2...  Off  | 00000000:00:04.0 Off |                    0 |
    | N/A   39C    P0    34W / 300W |      0MiB / 16130MiB |      0%      Default |
    +-------------------------------+----------------------+----------------------+
</code></pre></div></div>

<p>If you see any issues here you need to contact <code class="highlighter-rouge">SciComp</code> to have the error corrected</p>

<p>Also please email <code class="highlighter-rouge">SciComp</code> to request further assistance</p>


        
      </section>

      <footer class="page__meta">
        
        


        
          <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2018-12-28">December 28, 2018</time></p>
        
      </footer>

      <!-- <section class="page__share"> -->
<font size="2">
  <a href="http://github.com/FredHutch/wiki/blob/master/_compdemos/tensorflow-gpu.md"><i class="fas fa-pen-square"></i>
  <span> Edit this Page via GitHub</span></a> &nbsp; &nbsp; &nbsp;
  <a href="http://github.com/FredHutch/wiki/issues"><i class="far fa-comment-dots"></i><span> Comment by Filing an Issue</span></a>&nbsp; &nbsp; &nbsp;
  <a href="https://fhbig.slack.com/#question-and-answer"><i class="fas fa-question-circle"></i>
  <span> Have Questions? Ask them here.</span></a>
</font>
<hr>

<!--  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fcompdemos%2Ftensorflow-gpu%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a> -->
<!-- </section> -->


      
  <nav class="pagination">
    
      <a href="/compdemos/synology/" class="pagination--pager" title="Synology
">Previous</a>
    
    
      <a href="/compdemos/toolbox/" class="pagination--pager" title="using Toolbox to get Hutch master data
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form onsubmit="return googleCustomSearchExecute();" id="cse-search-box-form-id">
    <input type="text" id="cse-search-input-box-id" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
    </form>
    <div id="results" class="results">
        <gcse:searchresults-only></gcse:searchresults-only>    
    </div></div>

      </div>
    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
          <li><a href="/contributors/"><i class="fas fa-user-edit"></i> See our Contributors</a></li>

          <li><a href="https://github.com/FredHutch/wiki"><i class="fab fa-fw fa-github"></i> See our GitHub Repo</a></li>

          <li><a href="https://fhbig.slack.com/"><i class="fab fa-fw fa-slack"> </i> Join the Conversation on Slack</a></li>

          <li><a href="https://fredhutch.github.io/FHBig/"><img src="/images/FHBig.png" alt="fhbig" width="40" align="left|middle" hspace="0"> Find Upcoming Events</a></li>

          <li><a href="https://www.fredhutch.io/"><img src="/images/fhio.png" alt="fredhutchio" width="20" align="left|middle" hspace="0"> Find Training</a></li>


  </ul>
</div>

<div class="page__footer-copyright">&copy; 2019 Fred Hutch Biomedical Data Science Wiki. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.7.1/js/all.js" integrity="sha384-eVEQC9zshBn0rFj4+TU78eNA19HMNigMviK/PU/FFjLXqa/GKPgX58rvt5Z8PLs7" crossorigin="anonymous"></script>


<script>
  (function () {
    var cx = '018020560330782233421:waz3ch9w_wg';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();

  function googleCustomSearchExecute() {
    var input = document.getElementById('cse-search-input-box-id');
    var element = google.search.cse.element.getElement('searchresults-only0');
    if (input.value == '') {
      element.clearAllResults();
    } else {
      element.execute(input.value);
    }
    return false;
  }

  
</script>





  </body>
</html>
